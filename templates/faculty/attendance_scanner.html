{% extends "base.html" %}

{% block title %}Attendance Scanner - Faculty{% endblock %}

{% block extra_head %}
<!-- Try multiple CDNs to ensure the library loads -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Local fallback -->
<script src="/static/js/html5-qrcode.min.js"></script>
<script>
    // Check if the first CDN loaded successfully
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.log('First CDN failed, trying alternative...');
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
        script.onload = function() {
            console.log('Alternative CDN loaded successfully');
            // Re-run initialization
            if (typeof initializeAfterLibraryLoad === 'function') {
                initializeAfterLibraryLoad();
            }
        };
        script.onerror = function() {
            console.error('Alternative CDN also failed');
            // Try a third CDN
            const script2 = document.createElement('script');
            script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js';
            script2.onload = function() {
                console.log('Third CDN loaded successfully');
                if (typeof initializeAfterLibraryLoad === 'function') {
                    initializeAfterLibraryLoad();
                }
            };
            script2.onerror = function() {
                console.error('All CDNs failed, trying local version...');
                // Try local version as last resort
                const localScript = document.createElement('script');
                localScript.src = '/static/js/html5-qrcode.min.js';
                localScript.onload = function() {
                    console.log('Local version loaded successfully');
                    if (typeof initializeAfterLibraryLoad === 'function') {
                        initializeAfterLibraryLoad();
                    }
                };
                localScript.onerror = function() {
                    console.error('All sources failed including local');
                    showStatus('Failed to load QR scanner library. Please refresh the page.', 'error');
                };
                document.head.appendChild(localScript);
            };
            document.head.appendChild(script2);
        };
        document.head.appendChild(script);
    } else {
        console.log('First CDN loaded successfully');
    }
</script>
<style>
    .scanner-container {
        max-width: 600px;
        margin: 0 auto;
    }
    .qr-scanner {
        border: 2px solid #ddd;
        border-radius: 8px;
        margin: 20px 0;
    }
    .attendance-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .status-message {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .status-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    .status-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
    
    /* Scan feedback styles */
    .scan-feedback {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        z-index: 1000;
        animation: feedbackFadeIn 0.3s ease-in;
    }
    
    .scan-feedback-success {
        background: rgba(40, 167, 69, 0.9);
        border: 2px solid #28a745;
    }
    
    .scan-feedback-duplicate {
        background: rgba(255, 193, 7, 0.9);
        border: 2px solid #ffc107;
    }
    
    .feedback-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }
    
    .feedback-content i {
        font-size: 2rem;
    }
    
    .feedback-content span {
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .feedback-content small {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    @keyframes feedbackFadeIn {
        from {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.8);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
    }
    
    /* Scanner status indicator */
    .scanner-status {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        font-size: 0.9rem;
    }
    
    .scanner-status.scanning {
        background: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }
    
    .scanner-status.scanning i {
        color: #28a745;
        animation: pulse 1.5s infinite;
    }
    
    .scanner-status.cooldown {
        background: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
    
    .scanner-status.cooldown i {
        color: #ffc107;
        animation: pulse 1s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    /* Cooldown controls styling */
    .cooldown-controls {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-top: 8px;
    }
    
    .cooldown-controls button {
        padding: 4px 8px;
        font-size: 0.8rem;
    }
    
    .cooldown-display {
        font-weight: bold;
        color: #007bff;
    }
    
    .course-info {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-qrcode"></i> Attendance Scanner</h2>
            <p class="text-muted">Scan student QR codes to mark attendance</p>
        </div>
    </div>

    <div class="scanner-container">
        <!-- Course and Time Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Select Course and Time Slot</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="course-select" class="form-label">Course:</label>
                        <select id="course-select" class="form-select" onchange="updateSessionInfo()">
                            <option value="">Select a course...</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.code }} - {{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="timeslot-select" class="form-label">Time Slot:</label>
                        <select id="timeslot-select" class="form-select" onchange="updateSessionInfo()">
                            <option value="">Select a time slot...</option>
                            {% for slot in time_slots %}
                            <option value="{{ slot.id }}">{{ slot.day }} {{ slot.start_time }}-{{ slot.end_time }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course and Time Information Display -->
        <div class="course-info">
            <h5><i class="fas fa-info-circle"></i> Current Session</h5>
            <div class="row">
                <div class="col-md-6">
                    <strong>Course:</strong> <span id="course-display">Please select a course</span>
                </div>
                <div class="col-md-6">
                    <strong>Time Slot:</strong> <span id="timeslot-display">Please select a time slot</span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <strong>Date:</strong> <span id="date-display">{{ today }}</span>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-container"></div>

        <!-- Scanner Status and Controls -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Scanner Status & Settings</h5>
            </div>
            <div class="card-body">
                <!-- Scanner Status Indicator -->
                <div class="text-center mb-3">
                    <div id="scanner-status" class="scanner-status">
                        <i class="fas fa-stop-circle text-muted"></i>
                        <span class="text-muted">Scanner: Stopped</span>
                    </div>
                </div>
                
                <!-- Scan Cooldown Controls -->
                <div class="text-center">
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center justify-content-center gap-3">
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i> Scan Cooldown: <span id="cooldown-display" class="cooldown-display">2</span>s
                                </small>
                                <div class="cooldown-controls">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="decreaseScanCooldown()" title="Decrease cooldown">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" onclick="increaseScanCooldown()" title="Increase cooldown">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-warning" onclick="resetScanCooldown()" title="Reset to default">
                                        <i class="fas fa-undo"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Scanner Info -->
                <div class="text-center mt-3">
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-success">
                                <i class="fas fa-sync"></i> 
                                <strong>Continuous Scanning</strong>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <small class="text-info">
                                <i class="fas fa-clock"></i> 
                                <strong>Cooldown Protection</strong>
                            </small>
                        </div>
                        <div class="col-md-4">
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle"></i> 
                                <strong>Select Course & Time</strong>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Scanner -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-camera"></i> QR Code Scanner</h5>
            </div>
            <div class="card-body">
                <div id="qr-reader" class="qr-scanner"></div>
                <div id="qr-reader-results"></div>
                
                <!-- Manual Entry for QR Code Hash (if needed) -->
                <div id="manual-entry" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Scanner not working?</strong> Enter QR code hash manually:
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="manual-qr-input" placeholder="Enter QR code hash from student's phone">
                        <button class="btn btn-success" onclick="manualMarkAttendance()">
                            <i class="fas fa-check"></i> Mark Attendance
                        </button>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="startScanner()">
                        <i class="fas fa-play"></i> Start Scanner
                    </button>
                    <button class="btn btn-secondary" onclick="stopScanner()">
                        <i class="fas fa-stop"></i> Stop Scanner
                    </button>
                    <button class="btn btn-info" onclick="toggleManualEntry()">
                        <i class="fas fa-keyboard"></i> Manual Entry
                    </button>
                    <button class="btn btn-warning" onclick="testScanner()">
                        <i class="fas fa-vial"></i> Test Scanner
                    </button>
                    <button class="btn btn-outline-primary" onclick="testBasicJS()">
                        <i class="fas fa-check"></i> Test JS
                    </button>
                    <button class="btn btn-outline-warning" onclick="checkLibraryManually()">
                        <i class="fas fa-sync"></i> Check Library
                    </button>
                    <button class="btn btn-outline-info" onclick="checkCurrentState()">
                        <i class="fas fa-bug"></i> Debug State
                    </button>
                                         <button class="btn btn-outline-success" onclick="testAttendanceMarking()">
                         <i class="fas fa-test-tube"></i> Test Attendance
                     </button>
                     <button class="btn btn-outline-secondary" onclick="testScannerWithoutCamera()">
                         <i class="fas fa-cog"></i> Test Scanner
                     </button>
                     <button class="btn btn-outline-danger" onclick="testDirectAttendance()">
                         <i class="fas fa-bolt"></i> Direct Test
                     </button>
                     <button class="btn btn-outline-warning" onclick="simulateQRScan()">
                         <i class="fas fa-qrcode"></i> Simulate Scan
                     </button>
                                         <button class="btn btn-outline-info" onclick="checkSystemStatus()">
                        <i class="fas fa-info-circle"></i> System Status
                    </button>
                    <button class="btn btn-outline-warning" onclick="resetDuplicateTracking()">
                        <i class="fas fa-refresh"></i> Reset Duplicates
                    </button>
                    <button class="btn btn-outline-info" onclick="showScanningStats()">
                        <i class="fas fa-chart-bar"></i> Scan Stats
                    </button>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Manual entry is only needed if the scanner doesn't work or you need to enter a QR code hash manually
                    </small>
                </div>
            </div>
        </div>

        <!-- Recent Attendance -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Attendance</h5>
            </div>
            <div class="card-body">
                <div id="recent-attendance">
                    <p class="text-muted">No attendance marked yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('üîç QR Scanner script starting to load...');

let html5QrcodeScanner = null;
let recentAttendance = [];
let currentCourseId = null;
let currentTimeSlotId = null;
let scannedQRCodes = new Set(); // Track scanned QR codes to prevent duplicates
let isScanning = false; // Track if scanner is actively running
let lastScanTime = 0; // Track when last scan occurred
let scanCooldown = 2000; // Minimum time between scans (2 seconds)
let isProcessingScan = false; // Prevent multiple simultaneous scan processing
let countdownInterval = null; // Track countdown interval

// Get URL parameters
function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Update session information when course or time slot is selected
function updateSessionInfo() {
    const courseSelect = document.getElementById('course-select');
    const timeSlotSelect = document.getElementById('timeslot-select');
    
    if (!courseSelect || !timeSlotSelect) {
        console.error('Dropdown elements not found in updateSessionInfo');
        return false;
    }
    
    const courseId = courseSelect.value;
    const timeSlotId = timeSlotSelect.value;
    
    console.log('updateSessionInfo called - Course ID:', courseId, 'Time Slot ID:', timeSlotId);
    
    if (!courseId || !timeSlotId) {
        currentCourseId = null;
        currentTimeSlotId = null;
        document.getElementById('course-display').textContent = 'Please select a course';
        document.getElementById('timeslot-display').textContent = 'Please select a time slot';
        return false;
    }
    
    currentCourseId = courseId;
    currentTimeSlotId = timeSlotId;
    
    // Update display with selected values
    const selectedCourse = courseSelect.options[courseSelect.selectedIndex].text;
    const selectedTimeSlot = timeSlotSelect.options[timeSlotSelect.selectedIndex].text;
    
    console.log('Setting display values:', { selectedCourse, selectedTimeSlot });
    
    document.getElementById('course-display').textContent = selectedCourse;
    document.getElementById('timeslot-display').textContent = selectedTimeSlot;
    
    return true;
}

// Check current state of dropdowns and display debug info
function checkCurrentState() {
    console.log('=== Checking Current State ===');
    
    const courseSelect = document.getElementById('course-select');
    const timeSlotSelect = document.getElementById('timeslot-select');
    
    if (courseSelect) {
        console.log('Course dropdown found');
        console.log('Course dropdown value:', courseSelect.value);
        console.log('Course dropdown options count:', courseSelect.options.length);
        for (let i = 0; i < courseSelect.options.length; i++) {
            console.log(`Course option ${i}: value="${courseSelect.options[i].value}", text="${courseSelect.options[i].text}"`);
        }
    } else {
        console.error('Course dropdown NOT found');
    }
    
    if (timeSlotSelect) {
        console.log('Time slot dropdown found');
        console.log('Time slot dropdown value:', timeSlotSelect.value);
        console.log('Time slot dropdown options count:', timeSlotSelect.options.length);
        for (let i = 0; i < timeSlotSelect.options.length; i++) {
            console.log(`Time slot option ${i}: value="${timeSlotSelect.options[i].value}", text="${timeSlotSelect.options[i].text}"`);
        }
    } else {
        console.error('Time slot dropdown NOT found');
    }
    
    console.log('Current course ID:', currentCourseId);
    console.log('Current time slot ID:', currentTimeSlotId);
    console.log('=== End State Check ===');
}

// Initialize course and time slot information
function initializeSessionInfo() {
    console.log('Initializing session info...');
    
    // Check if dropdowns exist and have options
    const courseSelect = document.getElementById('course-select');
    const timeSlotSelect = document.getElementById('timeslot-select');
    
    if (!courseSelect || !timeSlotSelect) {
        console.error('Dropdown elements not found during initialization');
        return false;
    }
    
    console.log('Course dropdown options:', courseSelect.options.length);
    console.log('Time slot dropdown options:', timeSlotSelect.options.length);
    
    // Check if dropdowns have values
    if (courseSelect.options.length <= 1) {
        console.warn('Course dropdown has no options (only default option)');
        showStatus('Warning: No courses available. Please check if courses are assigned to you.', 'warning');
    }
    
    if (timeSlotSelect.options.length <= 1) {
        console.warn('Time slot dropdown has no options (only default option)');
        showStatus('Warning: No time slots available. Please check if time slots are configured.', 'warning');
    }
    
    // No need to get URL parameters anymore - just initialize the display
    document.getElementById('course-display').textContent = 'Please select a course';
    document.getElementById('timeslot-display').textContent = 'Please select a time slot';
    
    // Initialize scanner status
    updateScannerStatus();
    
    // Check current state after initialization
    setTimeout(checkCurrentState, 100);
    
    return true
}

function startScanner() {
    console.log('startScanner called with:', { currentCourseId, currentTimeSlotId });
    
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Please select both course and time slot before starting scanner', 'error');
        return;
    }
    
    // Check if HTML5 QR code library is loaded
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.error('Html5QrcodeScanner is not defined. Library may not be loaded.');
        showStatus('QR Scanner library not loaded. Please refresh the page.', 'error');
        return;
    }
    
    console.log('Html5QrcodeScanner is available:', Html5QrcodeScanner);
    
    // Check if the scanner container exists
    const scannerContainer = document.getElementById('qr-reader');
    if (!scannerContainer) {
        console.error('Scanner container not found');
        showStatus('Scanner container not found', 'error');
        return;
    }
    
    console.log('Scanner container found:', scannerContainer);
    
    if (html5QrcodeScanner) {
        console.log('Clearing existing scanner...');
        html5QrcodeScanner.clear();
    }
    
    // Clear the container first
    scannerContainer.innerHTML = '';
    
    console.log('Creating new QR scanner...');
    
    try {
        console.log('Creating scanner with config:', { fps: 10, qrbox: { width: 250, height: 250 } });
        
        html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader",
            { 
                fps: 10, 
                qrbox: { width: 250, height: 250 },
                rememberLastUsedCamera: true,
                showTorchButtonIfSupported: true
            },
            false
        );
        
        console.log('Scanner created successfully, rendering...');
        
                 // Render the scanner with proper error handling
         html5QrcodeScanner.render(
             function(decodedText, decodedResult) {
                 console.log('üéØ SCAN SUCCESS CALLBACK TRIGGERED!');
                 console.log('Decoded text:', decodedText);
                 console.log('Decoded result:', decodedResult);
                 onScanSuccess(decodedText, decodedResult);
             },
             function(error) {
                 console.log('‚ùå Scan failure callback triggered:', error);
                 onScanFailure(error);
             }
         );
        
                 showStatus('Scanner started successfully!', 'success');
         console.log('Scanner rendered successfully');
         
         // Set scanning state
         isScanning = true;
         updateScannerStatus();
         
         // Add a visual indicator that scanner is active
         scannerContainer.style.border = '3px solid #28a745';
         scannerContainer.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
         
         // Add a small delay to ensure scanner is fully initialized
         setTimeout(() => {
             console.log('Scanner initialization delay completed');
             showStatus('Scanner is ready to scan! Keep scanning until you press Stop.', 'success');
             
             // Check if scanner is still active
             if (html5QrcodeScanner) {
                 console.log('Scanner is still active after delay');
             } else {
                 console.log('Scanner was cleared during initialization');
             }
         }, 1000);
        
    } catch (error) {
        console.error('Error creating scanner:', error);
        showStatus('Error starting scanner: ' + error.message, 'error');
        scannerContainer.innerHTML = '<div class="alert alert-danger">Failed to start scanner: ' + error.message + '</div>';
    }
}

function stopScanner() {
    console.log('stopScanner called');
    
    if (html5QrcodeScanner) {
        console.log('Stopping existing scanner...');
        try {
            html5QrcodeScanner.clear();
            html5QrcodeScanner = null;
            
            // Reset scanning state
            isScanning = false;
            updateScannerStatus();
            
            // Reset cooldown and processing flags
            isProcessingScan = false;
            lastScanTime = 0;
            
            // Clear countdown interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // Reset cooldown display
            const cooldownDisplay = document.getElementById('cooldown-display');
            if (cooldownDisplay) {
                cooldownDisplay.style.color = '#007bff';
                cooldownDisplay.textContent = (scanCooldown / 1000);
            }
            
            // Reset visual indicators
            const scannerContainer = document.getElementById('qr-reader');
            if (scannerContainer) {
                scannerContainer.style.border = '2px solid #ddd';
                scannerContainer.style.boxShadow = 'none';
                scannerContainer.innerHTML = '<div class="alert alert-info">Scanner stopped. Click "Start Scanner" to begin again.</div>';
            }
            
            showStatus('Scanner stopped successfully', 'success');
        } catch (error) {
            console.error('Error stopping scanner:', error);
            showStatus('Error stopping scanner: ' + error.message, 'error');
        }
    } else {
        console.log('No scanner to stop');
        showStatus('No scanner is currently running', 'info');
    }
}

function onScanSuccess(decodedText, decodedResult) {
    console.log('QR Code scanned successfully:', decodedText);
    console.log('Scan result:', decodedResult);
    
    const currentTime = Date.now();
    
    // Check if already processing a scan
    if (isProcessingScan) {
        console.log('Already processing a scan, ignoring duplicate');
        return;
    }
    
    // Check if enough time has passed since last scan (cooldown) - APPLY TO ALL SCANS
    if (currentTime - lastScanTime < scanCooldown) {
        console.log('Scan cooldown active, ignoring scan. Time since last scan:', currentTime - lastScanTime, 'ms');
        showStatus(`Scan cooldown active. Please wait ${((scanCooldown - (currentTime - lastScanTime)) / 1000).toFixed(1)} seconds.`, 'warning');
        return;
    }
    
    // Set processing flag and update last scan time for ALL scans
    isProcessingScan = true;
    lastScanTime = currentTime;
    
    // Show cooldown status for ALL scans
    showCooldownStatus();
    
    // Check if this QR code was already scanned in this session
    if (scannedQRCodes.has(decodedText)) {
        console.log('QR code already scanned in this session:', decodedText);
        playSound('duplicate');
        showScanFeedback('duplicate', decodedText);
        showStatus('QR code already scanned in this session', 'warning');
        
        // Reset processing flag after cooldown for duplicate scans
        setTimeout(() => {
            isProcessingScan = false;
            console.log('Duplicate scan processing completed, ready for next scan');
        }, scanCooldown);
        
        return;
    }
    
    // Add QR code to scanned set immediately to prevent duplicates
    scannedQRCodes.add(decodedText);
    
    // Play success sound
    playSound('success');
    
    // Show visual feedback
    showScanFeedback('success', decodedText);
    
    // Mark attendance (but don't stop scanner)
    markQRAttendance(decodedText);
    
    // Scanner continues automatically - no need to stop
}

function onScanFailure(error) {
    // Handle scan failure silently
    console.log('Scan failure (this is normal):', error);
    
    // Scanner continues automatically - no need to stop
}

// Function to play sounds for different events
function playSound(type) {
    try {
        // Create audio context for sound generation
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        if (type === 'success') {
            // Success sound - ascending beep
            playBeep(audioContext, 800, 0.1, 'sine');
            setTimeout(() => playBeep(audioContext, 1000, 0.1, 'sine'), 100);
        } else if (type === 'error') {
            // Error sound - descending beep
            playBeep(audioContext, 600, 0.15, 'sawtooth');
            setTimeout(() => playBeep(audioContext, 400, 0.15, 'sawtooth'), 100);
        } else if (type === 'duplicate') {
            // Duplicate sound - two short beeps
            playBeep(audioContext, 500, 0.1, 'square');
            setTimeout(() => playBeep(audioContext, 500, 0.1, 'square'), 200);
        }
    } catch (error) {
        console.log('Sound playback not supported:', error);
    }
}

// Helper function to generate beep sounds
function playBeep(audioContext, frequency, duration, type) {
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = type;
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
}

// Function to show visual feedback for scans
function showScanFeedback(type, qrHash) {
    const scannerContainer = document.getElementById('qr-reader');
    if (!scannerContainer) return;
    
    // Create feedback element
    const feedback = document.createElement('div');
    feedback.className = `scan-feedback scan-feedback-${type}`;
    feedback.innerHTML = `
        <div class="feedback-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
            <span>${type === 'success' ? 'QR Code Scanned!' : 'Duplicate QR Code'}</span>
            <small>${qrHash.substring(0, 20)}...</small>
        </div>
    `;
    
    // Add to scanner container
    scannerContainer.appendChild(feedback);
    
    // Remove after 2 seconds
    setTimeout(() => {
        if (feedback.parentNode) {
            feedback.parentNode.removeChild(feedback);
        }
    }, 2000);
}

// Function to show cooldown status
function showCooldownStatus() {
    const currentTime = Date.now();
    const timeSinceLastScan = currentTime - lastScanTime;
    const remainingCooldown = Math.max(0, scanCooldown - timeSinceLastScan);
    
    if (remainingCooldown > 0) {
        const cooldownDisplay = document.getElementById('cooldown-display');
        if (cooldownDisplay) {
            cooldownDisplay.style.color = '#dc3545'; // Red during cooldown
            cooldownDisplay.textContent = (remainingCooldown / 1000).toFixed(1);
        }
        
        // Clear any existing countdown
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }
        
        // Start countdown timer
        countdownInterval = setInterval(() => {
            const now = Date.now();
            const timeSinceLastScan = now - lastScanTime;
            const remainingCooldown = Math.max(0, scanCooldown - timeSinceLastScan);
            
            if (remainingCooldown > 0) {
                if (cooldownDisplay) {
                    cooldownDisplay.textContent = (remainingCooldown / 1000).toFixed(1);
                }
                // Update scanner status to show cooldown
                updateScannerStatus();
            } else {
                // Cooldown finished
                clearInterval(countdownInterval);
                countdownInterval = null;
                if (cooldownDisplay) {
                    cooldownDisplay.style.color = '#007bff'; // Blue when ready
                    cooldownDisplay.textContent = (scanCooldown / 1000);
                }
                // Update scanner status to show ready
                updateScannerStatus();
            }
        }, 100); // Update every 100ms for smooth countdown
    }
}

// Function to check if QR code is duplicate
function isDuplicateQR(qrHash) {
    if (scannedQRCodes.has(qrHash)) {
        return true;
    }
    
    // Keep only last 100 scanned codes to prevent memory issues
    if (scannedQRCodes.size > 100) {
        const firstItem = scannedQRCodes.values().next().value;
        scannedQRCodes.delete(firstItem);
    }
    
    return false;
}

// Function to reset duplicate tracking
function resetDuplicateTracking() {
    scannedQRCodes.clear();
    isProcessingScan = false;
    lastScanTime = 0;
    
    // Clear countdown interval
    if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
    }
    
    // Reset cooldown display
    const cooldownDisplay = document.getElementById('cooldown-display');
    if (cooldownDisplay) {
        cooldownDisplay.style.color = '#007bff';
        cooldownDisplay.textContent = (scanCooldown / 1000);
    }
    
    showStatus('Duplicate tracking and cooldown reset', 'info');
}

// Function to update scanner status display
function updateScannerStatus() {
    const statusElement = document.getElementById('scanner-status');
    if (!statusElement) return;
    
    const currentTime = Date.now();
    const timeSinceLastScan = currentTime - lastScanTime;
    const isInCooldown = timeSinceLastScan < scanCooldown && lastScanTime > 0;
    
    if (isScanning) {
        if (isInCooldown) {
            const remainingCooldown = Math.max(0, scanCooldown - timeSinceLastScan);
            statusElement.className = 'scanner-status cooldown';
            statusElement.innerHTML = `<i class="fas fa-clock"></i><span>Scanner: Cooldown (${(remainingCooldown / 1000).toFixed(1)}s)</span>`;
        } else {
            statusElement.className = 'scanner-status scanning';
            statusElement.innerHTML = '<i class="fas fa-play-circle"></i><span>Scanner: Active - Keep Scanning</span>';
        }
    } else {
        statusElement.className = 'scanner-status';
        statusElement.innerHTML = '<i class="fas fa-stop-circle"></i><span>Scanner: Stopped</span>';
    }
}

// Function to show scanning statistics
function showScanningStats() {
    const currentTime = Date.now();
    const timeSinceLastScan = currentTime - lastScanTime;
    const remainingCooldown = Math.max(0, scanCooldown - timeSinceLastScan);
    const isInCooldown = remainingCooldown > 0;
    
    const stats = {
        totalScanned: scannedQRCodes.size,
        recentAttendance: recentAttendance.length,
        isScanning: isScanning,
        scanCooldown: scanCooldown / 1000,
        isInCooldown: isInCooldown,
        remainingCooldown: remainingCooldown / 1000,
        isProcessing: isProcessingScan
    };
    
    const message = `üìä Scanning Statistics:
‚Ä¢ Total QR Codes Scanned: ${stats.totalScanned}
‚Ä¢ Recent Attendance Records: ${stats.recentAttendance}
‚Ä¢ Scanner Status: ${stats.isScanning ? 'Active' : 'Stopped'}
‚Ä¢ Scan Cooldown: ${stats.scanCooldown} seconds
‚Ä¢ Currently Processing: ${stats.isProcessing ? 'Yes' : 'No'}
‚Ä¢ Cooldown Status: ${stats.isInCooldown ? `Active (${stats.remainingCooldown.toFixed(1)}s remaining)` : 'Ready'}`;
    
    showStatus(message, 'info');
}

// Function to adjust scan cooldown
function adjustScanCooldown(seconds) {
    scanCooldown = seconds * 1000;
    
    // Update display
    const cooldownDisplay = document.getElementById('cooldown-display');
    if (cooldownDisplay) {
        cooldownDisplay.textContent = seconds;
    }
    
    showStatus(`Scan cooldown adjusted to ${seconds} seconds`, 'success');
    console.log(`Scan cooldown set to ${seconds} seconds`);
}

// Function to increase scan cooldown
function increaseScanCooldown() {
    const newCooldown = Math.min(scanCooldown + 1000, 10000); // Max 10 seconds
    adjustScanCooldown(newCooldown / 1000);
}

// Function to decrease scan cooldown
function decreaseScanCooldown() {
    const newCooldown = Math.max(scanCooldown - 1000, 500); // Min 0.5 seconds
    adjustScanCooldown(newCooldown / 1000);
}

// Function to reset scan cooldown to default
function resetScanCooldown() {
    adjustScanCooldown(2); // Reset to 2 seconds
}

// Function to clear error messages
function clearErrorMessages() {
    const errorMessages = document.querySelectorAll('.status-error');
    errorMessages.forEach(msg => msg.remove());
}

// Function to clear success messages
function clearSuccessMessages() {
    const successMessages = document.querySelectorAll('.status-success');
    successMessages.forEach(msg => msg.remove());
}

function markQRAttendance(qrHash) {
    console.log('markQRAttendance called with qrHash:', qrHash);
    console.log('Current state - courseId:', currentCourseId, 'timeSlotId:', currentTimeSlotId);
    
    if (!currentCourseId || !currentTimeSlotId) {
        const errorMsg = 'Session information not available. Please select both course and time slot.';
        console.error(errorMsg);
        showStatus(errorMsg, 'error');
        
        // Show detailed error info
        if (!currentCourseId) showStatus('Course not selected', 'error');
        if (!currentTimeSlotId) showStatus('Time slot not selected', 'error');
        return;
    }
    
    if (!qrHash || qrHash.trim() === '') {
        const errorMsg = 'Invalid QR code hash received';
        console.error(errorMsg);
        showStatus(errorMsg, 'error');
        return;
    }
    
    // Note: Duplicate checking is now handled in onScanSuccess before calling this function
    
    // Prevent multiple simultaneous requests
    if (window.attendanceInProgress) {
        console.log('Attendance marking already in progress, ignoring duplicate request');
        return;
    }
    
    window.attendanceInProgress = true;
    
    // Set a timeout to reset the flag if it gets stuck
    const progressTimeout = setTimeout(() => {
        if (window.attendanceInProgress) {
            console.warn('Attendance progress flag stuck, resetting...');
            window.attendanceInProgress = false;
            showStatus('Attendance marking timed out. Please try again.', 'warning');
        }
    }, 30000); // 30 second timeout
    
    console.log('Sending attendance request with data:', {
        qr_hash: qrHash,
        course_id: currentCourseId,
        time_slot_id: currentTimeSlotId
    });
    
    // Show loading status
    showStatus('Marking attendance...', 'info');
    
    fetch('/scan_qr_code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            qr_hash: qrHash,
            course_id: currentCourseId,
            time_slot_id: currentTimeSlotId
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        clearTimeout(progressTimeout);
        window.attendanceInProgress = false;
        
        if (data.success) {
            showStatus(data.message, 'success');
            addToRecentAttendance(data.student_name, data.course_name);
            
            // Clear any previous error messages
            clearErrorMessages();
            
            // Show success feedback
            showScanFeedback('success', qrHash);
            
            // Play success sound
            playSound('success');
            
            // Show scanner continues message
            setTimeout(() => {
                if (isScanning) {
                    showStatus('Scanner continues... Ready for next QR code!', 'info');
                }
            }, 2000);
            
            // Reset processing flag after successful attendance marking
            setTimeout(() => {
                isProcessingScan = false;
                console.log('Scan processing completed, ready for next scan');
            }, scanCooldown); // Use the full cooldown time
        } else {
            const errorMsg = data.error || 'Unknown error occurred';
            console.error('Server returned error:', errorMsg);
            showStatus(errorMsg, 'error');
            
            // Play error sound
            playSound('error');
            
            // Don't retry on server errors to prevent loops
            if (errorMsg.includes('already marked') || errorMsg.includes('not found')) {
                console.log('Preventing retry for this type of error');
            }
            
            // Reset processing flag after error
            setTimeout(() => {
                isProcessingScan = false;
                console.log('Scan processing completed after error, ready for next scan');
            }, scanCooldown); // Use the full cooldown time
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        clearTimeout(progressTimeout);
        window.attendanceInProgress = false;
        
        const errorMsg = 'Error marking attendance: ' + error.message;
        showStatus(errorMsg, 'error');
        
        // Clear any previous success messages
        clearSuccessMessages();
        
        // Reset processing flag after error
        setTimeout(() => {
            isProcessingScan = false;
            console.log('Scan processing completed after fetch error, ready for next scan');
        }, scanCooldown); // Use the full cooldown time
    });
}

function showStatus(message, type) {
    const container = document.getElementById('status-container');
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.textContent = message;
    
    container.appendChild(statusDiv);
    
    // Remove status message after 5 seconds
    setTimeout(() => {
        statusDiv.remove();
    }, 5000);
}

function addToRecentAttendance(studentName, courseName) {
    const attendance = {
        student: studentName,
        course: courseName,
        timeSlot: document.getElementById('timeslot-display').textContent,
        timestamp: new Date().toLocaleTimeString()
    };
    
    recentAttendance.unshift(attendance);
    if (recentAttendance.length > 10) {
        recentAttendance.pop();
    }
    
    updateRecentAttendanceDisplay();
}

function updateRecentAttendanceDisplay() {
    const container = document.getElementById('recent-attendance');
    
    if (recentAttendance.length === 0) {
        container.innerHTML = '<p class="text-muted">No attendance marked yet.</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Student</th><th>Course</th><th>Time</th><th>Marked At</th></tr></thead><tbody>';
    
    recentAttendance.forEach(att => {
        html += `<tr>
            <td>${att.student}</td>
            <td>${att.course}</td>
            <td>${att.timeSlot}</td>
            <td>${att.timestamp}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function toggleManualEntry() {
    const manualEntry = document.getElementById('manual-entry');
    if (manualEntry.style.display === 'none') {
        manualEntry.style.display = 'block';
        document.getElementById('manual-qr-input').focus();
    } else {
        manualEntry.style.display = 'none';
    }
}

function manualMarkAttendance() {
    const qrInput = document.getElementById('manual-qr-input');
    const qrHash = qrInput.value.trim();
    
    if (!qrHash) {
        showStatus('Please enter a QR code hash', 'error');
        return;
    }
    
    console.log('Manual attendance marking with hash:', qrHash);
    markQRAttendance(qrHash);
    
    // Clear input after marking
    qrInput.value = '';
}

// Test function to simulate QR code scanning
function testAttendanceMarking() {
    console.log('Testing attendance marking...');
    
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Please select course and time slot first', 'error');
        return;
    }
    
    // Generate a test QR hash
    const testHash = 'test-qr-' + Date.now();
    console.log('Using test hash:', testHash);
    
    showStatus('Testing with sample QR code...', 'info');
    
    // Simulate the scan success flow
    console.log('Simulating scan success...');
    onScanSuccess(testHash, { decodedText: testHash });
}

function testScanner() {
    console.log('Testing scanner functionality...');
    
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Please select both course and time slot before testing', 'error');
        return;
    }
    
    // Test if we can create a scanner object
    if (typeof Html5QrcodeScanner === 'undefined') {
        showStatus('HTML5 QR Scanner library not loaded', 'error');
        return;
    }
    
    // Test if we can access the scanner container
    const scannerContainer = document.getElementById('qr-reader');
    if (!scannerContainer) {
        showStatus('Scanner container not found', 'error');
        return;
    }
    
    // Test camera availability
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                console.log('Camera access granted');
                showStatus('Camera access granted!', 'success');
                
                // Stop the stream
                stream.getTracks().forEach(track => track.stop());
                
                // Test if we can create a scanner instance
                try {
                    const testScanner = new Html5QrcodeScanner(
                        "qr-reader",
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        false
                    );
                    
                    showStatus('Scanner test successful! Library is working.', 'success');
                    
                    // Clean up test scanner
                    testScanner.clear();
                    
                    // Show test message in container
                    scannerContainer.innerHTML = '<div class="alert alert-success">Scanner test successful! Camera access granted. Click "Start Scanner" to begin scanning.</div>';
                    
                } catch (error) {
                    console.error('Scanner test failed:', error);
                    showStatus('Scanner test failed: ' + error.message, 'error');
                    scannerContainer.innerHTML = '<div class="alert alert-danger">Scanner test failed: ' + error.message + '</div>';
                }
            })
            .catch(function(err) {
                console.error('Camera access denied:', err);
                showStatus('Camera access denied: ' + err.message, 'error');
                scannerContainer.innerHTML = '<div class="alert alert-warning">Camera access denied. Please allow camera access to use the QR scanner.</div>';
            });
    } else {
        showStatus('Camera not available on this device', 'error');
        scannerContainer.innerHTML = '<div class="alert alert-danger">Camera not available on this device.</div>';
    }
}

// Add a new function to test the scanner without camera
function testScannerWithoutCamera() {
    console.log('Testing scanner without camera...');
    
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Please select both course and time slot before testing', 'error');
        return;
    }
    
    // Test if we can create a scanner object
    if (typeof Html5QrcodeScanner === 'undefined') {
        showStatus('HTML5 QR Scanner library not loaded', 'error');
        return;
    }
    
    // Test if we can access the scanner container
    const scannerContainer = document.getElementById('qr-reader');
    if (!scannerContainer) {
        showStatus('Scanner container not found', 'error');
        return;
    }
    
    try {
        // Create a test scanner instance
        const testScanner = new Html5QrcodeScanner(
            "qr-reader",
            { fps: 10, qrbox: { width: 250, height: 250 } },
            false
        );
        
        showStatus('Scanner creation test successful!', 'success');
        
        // Clean up test scanner
        testScanner.clear();
        
        // Show test message in container
        scannerContainer.innerHTML = '<div class="alert alert-success">Scanner creation test successful! Library is working correctly.</div>';
        
    } catch (error) {
        console.error('Scanner creation test failed:', error);
        showStatus('Scanner creation test failed: ' + error.message, 'error');
        scannerContainer.innerHTML = '<div class="alert alert-danger">Scanner creation test failed: ' + error.message + '</div>';
         }
 }

 // Test attendance marking directly without scanner
 function testDirectAttendance() {
     console.log('Testing direct attendance marking...');
     
     if (!currentCourseId || !currentTimeSlotId) {
         showStatus('Please select course and time slot first', 'error');
         return;
     }
     
     // Generate a test QR hash
     const testHash = 'test-qr-' + Date.now();
     console.log('Using test hash:', testHash);
     
     showStatus('Testing direct attendance marking...', 'info');
     
     // Call markQRAttendance directly
     markQRAttendance(testHash);
 }

 // Simulate a QR code scan to test the flow
 function simulateQRScan() {
     console.log('Simulating QR code scan...');
     
     if (!currentCourseId || !currentTimeSlotId) {
         showStatus('Please select course and time slot first', 'error');
         return;
     }
     
     // Generate a test QR hash
     const testHash = 'test-qr-' + Date.now();
     console.log('Simulating scan with hash:', testHash);
     
     showStatus('Simulating QR code scan...', 'info');
     
     // Simulate the exact flow that would happen after a real scan
     console.log('üéØ Simulating scan success callback...');
     onScanSuccess(testHash, { decodedText: testHash });
 }

 function checkScannerStatus() {
    const status = {
        libraryLoaded: typeof Html5QrcodeScanner !== 'undefined',
        scannerActive: html5QrcodeScanner !== null,
        courseSelected: currentCourseId !== null,
        timeSlotSelected: currentTimeSlotId !== null,
        cameraAvailable: navigator.mediaDevices && navigator.mediaDevices.getUserMedia
    };
    
    console.log('Scanner Status:', status);
    
    let statusMessage = 'Scanner Status:\n';
    statusMessage += `Library Loaded: ${status.libraryLoaded ? '‚úÖ' : '‚ùå'}\n`;
    statusMessage += `Scanner Active: ${status.scannerActive ? '‚úÖ' : '‚ùå'}\n`;
    statusMessage += `Course Selected: ${status.courseSelected ? '‚úÖ' : '‚ùå'}\n`;
    statusMessage += `Time Slot Selected: ${status.timeSlotSelected ? '‚úÖ' : '‚ùå'}\n`;
    statusMessage += `Camera Available: ${status.cameraAvailable ? '‚úÖ' : '‚ùå'}`;
    
    showStatus(statusMessage, 'info');
    
         return status;
 }

 // Check system status including students, courses, and time slots
 function checkSystemStatus() {
     console.log('Checking system status...');
     
     // Check if we have the required data
     const courseSelect = document.getElementById('course-select');
     const timeSlotSelect = document.getElementById('timeslot-select');
     
     let statusMessage = 'System Status:\n';
     
     if (courseSelect && courseSelect.options.length > 1) {
         statusMessage += `‚úÖ Courses: ${courseSelect.options.length - 1} available\n`;
     } else {
         statusMessage += `‚ùå Courses: No courses available\n`;
     }
     
     if (timeSlotSelect && timeSlotSelect.options.length > 1) {
         statusMessage += `‚úÖ Time Slots: ${timeSlotSelect.options.length - 1} available\n`;
     } else {
         statusMessage += `‚ùå Time Slots: No time slots available\n`;
     }
     
     if (currentCourseId && currentTimeSlotId) {
         statusMessage += `‚úÖ Session: Course ${currentCourseId}, Time Slot ${currentTimeSlotId}\n`;
     } else {
         statusMessage += `‚ùå Session: Please select course and time slot\n`;
     }
     
     // Add warning about students if needed
     statusMessage += `\nüí° Note: Test attendance requires at least one student in the system.`;
     
     showStatus(statusMessage, 'info');
     
     return statusMessage;
 }

function testBasicJS() {
    console.log('Basic JS test function called');
    alert('Basic JavaScript is working!');
    
    // Test DOM manipulation
    const statusContainer = document.getElementById('status-container');
    if (statusContainer) {
        const testDiv = document.createElement('div');
        testDiv.className = 'status-message status-success';
        testDiv.textContent = 'Basic JavaScript test passed!';
        statusContainer.appendChild(testDiv);
        
        // Remove after 3 seconds
        setTimeout(() => {
            testDiv.remove();
        }, 3000);
    }
    
    // Test if we can access the scanner container
    const scannerContainer = document.getElementById('qr-reader');
    if (scannerContainer) {
        scannerContainer.innerHTML = '<div class="alert alert-info">Basic JS test passed! Scanner container is accessible.</div>';
    }
}

function checkLibraryManually() {
    console.log('Checking HTML5 QR library manually...');
    if (typeof Html5QrcodeScanner !== 'undefined') {
        showStatus('HTML5 QR Scanner library is already loaded!', 'info');
        
        // Test if we can create a scanner instance
        try {
            const testScanner = new Html5QrcodeScanner(
                "qr-reader",
                { fps: 10, qrbox: { width: 250, height: 250 } },
                false
            );
            showStatus('Library test successful! Can create scanner instance.', 'success');
            
            // Clean up test scanner
            testScanner.clear();
            
        } catch (error) {
            showStatus('Library loaded but scanner creation failed: ' + error.message, 'error');
        }
    } else {
        showStatus('HTML5 QR Scanner library is NOT loaded. Please refresh the page.', 'error');
    }
}

// Function to re-initialize after library loads
function initializeAfterLibraryLoad() {
    console.log('Library loaded, re-initializing scanner...');
    
    // Update the status
    if (typeof Html5QrcodeScanner !== 'undefined') {
        showStatus('HTML5 QR Scanner library loaded successfully!', 'success');
        
        // Re-run the DOM ready initialization
        if (typeof initializeSessionInfo === 'function') {
            initializeSessionInfo();
        }
        
        // Update the status display
        const statusButton = document.querySelector('.btn-outline-secondary');
        if (statusButton) {
            statusButton.innerHTML = '<i class="fas fa-info-circle"></i> Status (Library Ready)';
            statusButton.className = 'btn btn-success ms-2';
        }
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing attendance scanner...');
    
    // Reset attendance progress flag
    window.attendanceInProgress = false;
    
    // Check if HTML5 QR code library is loaded
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.error('‚ùå Html5QrcodeScanner is not defined. Library may not be loaded.');
        showStatus('QR Scanner library not loaded. Please refresh the page.', 'error');
        
        // Wait a bit and check again (in case local fallback is still loading)
        setTimeout(function() {
            if (typeof Html5QrcodeScanner !== 'undefined') {
                console.log('‚úÖ Html5QrcodeScanner is now available after delay');
                showStatus('QR Scanner library loaded successfully!', 'success');
            } else {
                console.error('‚ùå Html5QrcodeScanner still not available after delay');
            }
        }, 2000);
    } else {
        console.log('‚úÖ Html5QrcodeScanner is loaded successfully');
        showStatus('QR Scanner library loaded successfully!', 'success');
    }
    
    if (!initializeSessionInfo()) {
        console.error('Failed to initialize session info');
        return;
    }
    
    // Check if we came from a specific class (URL parameters)
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('course');
    const timeSlotId = urlParams.get('time_slot');
    
    console.log('URL Parameters found:', { courseId, timeSlotId });
    console.log('Full URL:', window.location.href);
    
    // Debug dropdown contents
    const courseSelect = document.getElementById('course-select');
    const timeSlotSelect = document.getElementById('timeslot-select');
    
    if (courseSelect) {
        console.log('Course dropdown found with options:', courseSelect.options.length);
        for (let i = 0; i < courseSelect.options.length; i++) {
            console.log(`Option ${i}:`, courseSelect.options[i].value, courseSelect.options[i].text);
        }
    } else {
        console.error('Course dropdown not found');
    }
    
    if (timeSlotSelect) {
        console.log('Time slot dropdown found with options:', timeSlotSelect.options.length);
        for (let i = 0; i < timeSlotSelect.options.length; i++) {
            console.log(`Option ${i}:`, timeSlotSelect.options[i].value, timeSlotSelect.options[i].text);
        }
    } else {
        console.error('Time slot dropdown not found');
    }
    
    if (courseId && timeSlotId) {
        console.log('Auto-filling dropdowns with:', { courseId, timeSlotId });
        
        if (courseSelect && timeSlotSelect) {
            // Check if the values exist in the dropdowns
            const courseExists = Array.from(courseSelect.options).some(opt => opt.value === courseId);
            const timeSlotExists = Array.from(timeSlotSelect.options).some(opt => opt.value === timeSlotId);
            
            console.log('Values exist in dropdowns:', { courseExists, timeSlotExists });
            
            if (courseExists && timeSlotExists) {
                courseSelect.value = courseId;
                timeSlotSelect.value = timeSlotId;
                updateSessionInfo();
                
                // Auto-start scanner after a short delay
                setTimeout(() => {
                    startScanner();
                }, 1000);
            } else {
                console.error('Course or time slot values not found in dropdowns');
            }
        } else {
            console.error('Dropdown elements not found');
        }
    } else {
        console.log('No URL parameters found. Manual selection required.');
    }

    // Add status check button after the existing buttons
    const buttonContainer = document.querySelector('.text-center.mt-3');
    if (buttonContainer) {
        const statusButton = document.createElement('button');
        statusButton.className = 'btn btn-outline-secondary ms-2';
        statusButton.onclick = checkScannerStatus;
        statusButton.innerHTML = '<i class="fas fa-info-circle"></i> Status';
        buttonContainer.appendChild(statusButton);
    }
});

// Also check on window load as a fallback
window.addEventListener('load', function() {
    console.log('üîÑ Window loaded, checking HTML5 QR library...');
    
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.error('‚ùå Html5QrcodeScanner still not defined after window load');
        
        // Try to load the library one more time
        console.log('üîÑ Attempting to load library again...');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js';
        script.onload = function() {
            console.log('‚úÖ Library loaded successfully on second attempt');
            initializeAfterLibraryLoad();
        };
        script.onerror = function() {
            console.error('‚ùå Second attempt also failed, trying local version...');
            const localScript = document.createElement('script');
            localScript.src = '/static/js/html5-qrcode.min.js';
            localScript.onload = function() {
                console.log('‚úÖ Local version loaded successfully');
                initializeAfterLibraryLoad();
            };
            localScript.onerror = function() {
                console.error('‚ùå Local version also failed');
                showStatus('Failed to load QR scanner library. Please check your internet connection and refresh the page.', 'error');
            };
            document.head.appendChild(localScript);
        };
        document.head.appendChild(script);
    } else {
        console.log('‚úÖ Html5QrcodeScanner is now available after window load');
    }
});

// Add a periodic check for the library
setInterval(function() {
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.log('üîÑ Periodic check: Library still not loaded');
    } else {
        console.log('‚úÖ Periodic check: Library is now loaded');
        clearInterval(this);
    }
}, 2000);

// Add periodic update for scanner status
setInterval(function() {
    if (isScanning) {
        updateScannerStatus();
    }
}, 500); // Update every 500ms when scanning
</script>
{% endblock %}
