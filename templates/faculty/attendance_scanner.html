{% extends "base.html" %}

{% block title %}Attendance Scanner - Faculty{% endblock %}

{% block extra_head %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<style>
    .scanner-container {
        max-width: 600px;
        margin: 0 auto;
    }
    .qr-scanner {
        border: 2px solid #ddd;
        border-radius: 8px;
        margin: 20px 0;
    }
    .attendance-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .status-message {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .course-info {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-qrcode"></i> Attendance Scanner</h2>
            <p class="text-muted">Scan student QR codes to mark attendance</p>
        </div>
    </div>

    <div class="scanner-container">
        <!-- Course and Time Information Display -->
        <div class="course-info">
            <h5><i class="fas fa-info-circle"></i> Current Session</h5>
            <div class="row">
                <div class="col-md-6">
                    <strong>Course:</strong> <span id="course-display">Loading...</span>
                </div>
                <div class="col-md-6">
                    <strong>Time Slot:</strong> <span id="timeslot-display">Loading...</span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <strong>Date:</strong> <span id="date-display">{{ today }}</span>
                </div>
            </div>
        </div>

        <!-- QR Scanner -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-camera"></i> QR Code Scanner</h5>
            </div>
            <div class="card-body">
                <div id="qr-reader" class="qr-scanner"></div>
                <div id="qr-reader-results"></div>
                
                <!-- Fallback Manual Entry -->
                <div id="manual-entry" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Scanner not available?</strong> Enter QR code manually:
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="manual-qr-input" placeholder="Enter QR code hash">
                        <button class="btn btn-success" onclick="manualMarkAttendance()">
                            <i class="fas fa-check"></i> Mark Attendance
                        </button>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="startScanner()">
                        <i class="fas fa-play"></i> Start Scanner
                    </button>
                    <button class="btn btn-secondary" onclick="stopScanner()">
                        <i class="fas fa-stop"></i> Stop Scanner
                    </button>
                    <button class="btn btn-info" onclick="toggleManualEntry()">
                        <i class="fas fa-keyboard"></i> Manual Entry
                    </button>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-container"></div>

        <!-- Recent Attendance -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Attendance</h5>
            </div>
            <div class="card-body">
                <div id="recent-attendance">
                    <p class="text-muted">No attendance marked yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let html5QrcodeScanner = null;
let recentAttendance = [];
let currentCourseId = null;
let currentTimeSlotId = null;

// Get URL parameters
function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Initialize course and time slot information
function initializeSessionInfo() {
    const courseId = getUrlParameter('course');
    const timeSlotId = getUrlParameter('time_slot');
    
    console.log('URL Parameters - Course ID:', courseId, 'Time Slot ID:', timeSlotId);
    
    if (!courseId || !timeSlotId) {
        showStatus('Error: Course and time slot information is missing. Please go back to dashboard and try again.', 'error');
        return false;
    }
    
    currentCourseId = courseId;
    currentTimeSlotId = timeSlotId;
    
    // Fetch course and time slot details to display
    fetch(`/api/course/${courseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('course-display').textContent = `${data.course.code} - ${data.course.name}`;
                console.log('Course data loaded:', data.course);
            } else {
                document.getElementById('course-display').textContent = 'Course error: ' + data.error;
                console.error('Course API error:', data.error);
            }
        })
        .catch(error => {
            document.getElementById('course-display').textContent = 'Course information unavailable';
            console.error('Course fetch error:', error);
        });
    
    fetch(`/api/timeslot/${timeSlotId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('timeslot-display').textContent = `${data.timeslot.day} ${data.timeslot.start_time}-${data.timeslot.end_time}`;
                console.log('Time slot data loaded:', data.timeslot);
            } else {
                document.getElementById('timeslot-display').textContent = 'Time slot error: ' + data.error;
                console.error('Time slot API error:', data.error);
            }
        })
        .catch(error => {
            document.getElementById('timeslot-display').textContent = 'Time slot information unavailable';
            console.error('Time slot fetch error:', error);
        });
    
    return true;
}

function startScanner() {
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Session information not loaded. Please refresh the page.', 'error');
        return;
    }
    
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
    }
    
    html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader",
        { fps: 10, qrbox: { width: 250, height: 250 } },
        false
    );
    
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
}

function stopScanner() {
    if (html5QrcodeScanner) {
        html5QrcodeScanner.clear();
        html5QrcodeScanner = null;
    }
}

function onScanSuccess(decodedText, decodedResult) {
    // Stop scanner after successful scan
    stopScanner();
    
    // Mark attendance
    markAttendance(decodedText);
}

function onScanFailure(error) {
    // Handle scan failure silently
}

function markAttendance(qrHash) {
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Session information not available', 'error');
        return;
    }
    
    fetch('/scan_qr_code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            qr_hash: qrHash,
            course_id: currentCourseId,
            time_slot_id: currentTimeSlotId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(data.message, 'success');
            addToRecentAttendance(data.student_name, data.course_name);
        } else {
            showStatus(data.error, 'error');
        }
    })
    .catch(error => {
        showStatus('Error marking attendance: ' + error, 'error');
    });
}

function showStatus(message, type) {
    const container = document.getElementById('status-container');
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.textContent = message;
    
    container.appendChild(statusDiv);
    
    // Remove status message after 5 seconds
    setTimeout(() => {
        statusDiv.remove();
    }, 5000);
}

function addToRecentAttendance(studentName, courseName) {
    const attendance = {
        student: studentName,
        course: courseName,
        timeSlot: document.getElementById('timeslot-display').textContent,
        timestamp: new Date().toLocaleTimeString()
    };
    
    recentAttendance.unshift(attendance);
    if (recentAttendance.length > 10) {
        recentAttendance.pop();
    }
    
    updateRecentAttendanceDisplay();
}

function updateRecentAttendanceDisplay() {
    const container = document.getElementById('recent-attendance');
    
    if (recentAttendance.length === 0) {
        container.innerHTML = '<p class="text-muted">No attendance marked yet.</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Student</th><th>Course</th><th>Time</th><th>Marked At</th></tr></thead><tbody>';
    
    recentAttendance.forEach(att => {
        html += `<tr>
            <td>${att.student}</td>
            <td>${att.course}</td>
            <td>${att.timeSlot}</td>
            <td>${att.timestamp}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function toggleManualEntry() {
    const manualEntry = document.getElementById('manual-entry');
    if (manualEntry.style.display === 'none') {
        manualEntry.style.display = 'block';
        document.getElementById('manual-qr-input').focus();
    } else {
        manualEntry.style.display = 'none';
    }
}

function manualMarkAttendance() {
    const qrHash = document.getElementById('manual-qr-input').value.trim();
    if (!qrHash) {
        showStatus('Please enter a QR code hash', 'error');
        return;
    }
    
    markAttendance(qrHash);
    document.getElementById('manual-qr-input').value = '';
    document.getElementById('manual-entry').style.display = 'none';
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    if (!initializeSessionInfo()) {
        return;
    }
    
    // Auto-start scanner after a short delay
    setTimeout(() => {
        startScanner();
    }, 1000);
});
</script>
{% endblock %}
