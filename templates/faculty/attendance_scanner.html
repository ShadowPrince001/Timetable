{% extends "base.html" %}

{% block title %}Attendance Scanner - Faculty{% endblock %}

{% block extra_head %}
<!-- Try multiple CDNs to ensure the library loads -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<!-- Local fallback -->
<script src="/static/js/html5-qrcode.min.js"></script>
<script>
    // Check if the first CDN loaded successfully
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.log('First CDN failed, trying alternative...');
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js';
        script.onload = function() {
            console.log('Alternative CDN loaded successfully');
            // Re-run initialization
            if (typeof initializeAfterLibraryLoad === 'function') {
                initializeAfterLibraryLoad();
            }
        };
        script.onerror = function() {
            console.error('Alternative CDN also failed');
            // Try a third CDN
            const script2 = document.createElement('script');
            script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js';
            script2.onload = function() {
                console.log('Third CDN loaded successfully');
                if (typeof initializeAfterLibraryLoad === 'function') {
                    initializeAfterLibraryLoad();
                }
            };
            script2.onerror = function() {
                console.error('All CDNs failed, trying local version...');
                // Try local version as last resort
                const localScript = document.createElement('script');
                localScript.src = '/static/js/html5-qrcode.min.js';
                localScript.onload = function() {
                    console.log('Local version loaded successfully');
                    if (typeof initializeAfterLibraryLoad === 'function') {
                        initializeAfterLibraryLoad();
                    }
                };
                localScript.onerror = function() {
                    console.error('All sources failed including local');
                    showStatus('Failed to load QR scanner library. Please refresh the page.', 'error');
                };
                document.head.appendChild(localScript);
            };
            document.head.appendChild(script2);
        };
        document.head.appendChild(script);
    } else {
        console.log('First CDN loaded successfully');
    }
</script>
<style>
    .scanner-container {
        max-width: 600px;
        margin: 0 auto;
    }
    .qr-scanner {
        border: 2px solid #ddd;
        border-radius: 8px;
        margin: 20px 0;
    }
    .attendance-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .status-message {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
    }
    .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .course-info {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="fas fa-qrcode"></i> Attendance Scanner</h2>
            <p class="text-muted">Scan student QR codes to mark attendance</p>
        </div>
    </div>

    <div class="scanner-container">
        <!-- Course and Time Selection -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-cog"></i> Select Course and Time Slot</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="course-select" class="form-label">Course:</label>
                        <select id="course-select" class="form-select" onchange="updateSessionInfo()">
                            <option value="">Select a course...</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}">{{ course.code }} - {{ course.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="timeslot-select" class="form-label">Time Slot:</label>
                        <select id="timeslot-select" class="form-select" onchange="updateSessionInfo()">
                            <option value="">Select a time slot...</option>
                            {% for slot in time_slots %}
                            <option value="{{ slot.id }}">{{ slot.day }} {{ slot.start_time }}-{{ slot.end_time }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course and Time Information Display -->
        <div class="course-info">
            <h5><i class="fas fa-info-circle"></i> Current Session</h5>
            <div class="row">
                <div class="col-md-6">
                    <strong>Course:</strong> <span id="course-display">Please select a course</span>
                </div>
                <div class="col-md-6">
                    <strong>Time Slot:</strong> <span id="timeslot-display">Please select a time slot</span>
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-12">
                    <strong>Date:</strong> <span id="date-display">{{ today }}</span>
                </div>
            </div>
        </div>

        <!-- QR Scanner -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-camera"></i> QR Code Scanner</h5>
            </div>
            <div class="card-body">
                <div id="qr-reader" class="qr-scanner"></div>
                <div id="qr-reader-results"></div>
                
                <!-- Manual Entry for QR Code Hash (if needed) -->
                <div id="manual-entry" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <strong>Scanner not working?</strong> Enter QR code hash manually:
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="manual-qr-input" placeholder="Enter QR code hash from student's phone">
                        <button class="btn btn-success" onclick="manualMarkAttendance()">
                            <i class="fas fa-check"></i> Mark Attendance
                        </button>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="btn btn-primary" onclick="startScanner()">
                        <i class="fas fa-play"></i> Start Scanner
                    </button>
                    <button class="btn btn-secondary" onclick="stopScanner()">
                        <i class="fas fa-stop"></i> Stop Scanner
                    </button>
                    <button class="btn btn-info" onclick="toggleManualEntry()">
                        <i class="fas fa-keyboard"></i> Manual Entry
                    </button>
                    <button class="btn btn-warning" onclick="testScanner()">
                        <i class="fas fa-vial"></i> Test Scanner
                    </button>
                    <button class="btn btn-outline-primary" onclick="testBasicJS()">
                        <i class="fas fa-check"></i> Test JS
                    </button>
                    <button class="btn btn-outline-warning" onclick="checkLibraryManually()">
                        <i class="fas fa-sync"></i> Check Library
                    </button>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i> 
                        Manual entry is only needed if the scanner doesn't work or you need to enter a QR code hash manually
                    </small>
                </div>
                <div class="text-center mt-2">
                    <small class="text-info">
                        <i class="fas fa-exclamation-triangle"></i> 
                        If course/time slot are not auto-filled, please select them manually from the dropdowns above
                    </small>
                </div>
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status-container"></div>

        <!-- Recent Attendance -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Attendance</h5>
            </div>
            <div class="card-body">
                <div id="recent-attendance">
                    <p class="text-muted">No attendance marked yet.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
console.log('üîç QR Scanner script starting to load...');

let html5QrcodeScanner = null;
let recentAttendance = [];
let currentCourseId = null;
let currentTimeSlotId = null;

// Get URL parameters
function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// Update session information when course or time slot is selected
function updateSessionInfo() {
    const courseSelect = document.getElementById('course-select');
    const timeSlotSelect = document.getElementById('timeslot-select');
    
    if (!courseSelect || !timeSlotSelect) {
        console.error('Dropdown elements not found in updateSessionInfo');
        return false;
    }
    
    const courseId = courseSelect.value;
    const timeSlotId = timeSlotSelect.value;
    
    console.log('updateSessionInfo called - Course ID:', courseId, 'Time Slot ID:', timeSlotId);
    
    if (!courseId || !timeSlotId) {
        currentCourseId = null;
        currentTimeSlotId = null;
        document.getElementById('course-display').textContent = 'Please select a course';
        document.getElementById('timeslot-display').textContent = 'Please select a time slot';
        return false;
    }
    
    currentCourseId = courseId;
    currentTimeSlotId = timeSlotId;
    
    // Update display with selected values
    const selectedCourse = courseSelect.options[courseSelect.selectedIndex].text;
    const selectedTimeSlot = timeSlotSelect.options[timeSlotSelect.selectedIndex].text;
    
    console.log('Setting display values:', { selectedCourse, selectedTimeSlot });
    
    document.getElementById('course-display').textContent = selectedCourse;
    document.getElementById('timeslot-display').textContent = selectedTimeSlot;
    
    return true;
}

// Initialize course and time slot information
function initializeSessionInfo() {
    // No need to get URL parameters anymore - just initialize the display
    document.getElementById('course-display').textContent = 'Please select a course';
    document.getElementById('timeslot-display').textContent = 'Please select a time slot';
    return true;
}

function startScanner() {
    console.log('startScanner called with:', { currentCourseId, currentTimeSlotId });
    
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Please select both course and time slot before starting scanner', 'error');
        return;
    }
    
    // Check if HTML5 QR code library is loaded
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.error('Html5QrcodeScanner is not defined. Library may not be loaded.');
        showStatus('QR Scanner library not loaded. Please refresh the page.', 'error');
        return;
    }
    
    console.log('Html5QrcodeScanner is available:', Html5QrcodeScanner);
    
    // Check if the scanner container exists
    const scannerContainer = document.getElementById('qr-reader');
    if (!scannerContainer) {
        console.error('Scanner container not found');
        showStatus('Scanner container not found', 'error');
        return;
    }
    
    console.log('Scanner container found:', scannerContainer);
    
    if (html5QrcodeScanner) {
        console.log('Clearing existing scanner...');
        html5QrcodeScanner.clear();
    }
    
    // Clear the container first
    scannerContainer.innerHTML = '';
    
    console.log('Creating new QR scanner...');
    
    try {
        html5QrcodeScanner = new Html5QrcodeScanner(
            "qr-reader",
            { fps: 10, qrbox: { width: 250, height: 250 } },
            false
        );
        
        console.log('Scanner created successfully, rendering...');
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        showStatus('Scanner started successfully!', 'success');
        console.log('Scanner rendered successfully');
        
        // Add a visual indicator that scanner is active
        scannerContainer.style.border = '3px solid #28a745';
        scannerContainer.style.boxShadow = '0 0 10px rgba(40, 167, 69, 0.5)';
        
    } catch (error) {
        console.error('Error creating scanner:', error);
        showStatus('Error starting scanner: ' + error.message, 'error');
        scannerContainer.innerHTML = '<div class="alert alert-danger">Failed to start scanner: ' + error.message + '</div>';
    }
}

function stopScanner() {
    console.log('stopScanner called');
    
    if (html5QrcodeScanner) {
        console.log('Stopping existing scanner...');
        try {
            html5QrcodeScanner.clear();
            html5QrcodeScanner = null;
            
            // Reset visual indicators
            const scannerContainer = document.getElementById('qr-reader');
            if (scannerContainer) {
                scannerContainer.style.border = '2px solid #ddd';
                scannerContainer.style.boxShadow = 'none';
                scannerContainer.innerHTML = '<div class="alert alert-info">Scanner stopped. Click "Start Scanner" to begin again.</div>';
            }
            
            showStatus('Scanner stopped successfully', 'success');
        } catch (error) {
            console.error('Error stopping scanner:', error);
            showStatus('Error stopping scanner: ' + error.message, 'error');
        }
    } else {
        console.log('No scanner to stop');
        showStatus('No scanner is currently running', 'info');
    }
}

function onScanSuccess(decodedText, decodedResult) {
    // Stop scanner after successful scan
    stopScanner();
    
    // Mark attendance
    markAttendance(decodedText);
}

function onScanFailure(error) {
    // Handle scan failure silently
}

function markAttendance(qrHash) {
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Session information not available', 'error');
        return;
    }
    
    fetch('/scan_qr_code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            qr_hash: qrHash,
            course_id: currentCourseId,
            time_slot_id: currentTimeSlotId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(data.message, 'success');
            addToRecentAttendance(data.student_name, data.course_name);
        } else {
            showStatus(data.error, 'error');
        }
    })
    .catch(error => {
        showStatus('Error marking attendance: ' + error, 'error');
    });
}

function showStatus(message, type) {
    const container = document.getElementById('status-container');
    const statusDiv = document.createElement('div');
    statusDiv.className = `status-message status-${type}`;
    statusDiv.textContent = message;
    
    container.appendChild(statusDiv);
    
    // Remove status message after 5 seconds
    setTimeout(() => {
        statusDiv.remove();
    }, 5000);
}

function addToRecentAttendance(studentName, courseName) {
    const attendance = {
        student: studentName,
        course: courseName,
        timeSlot: document.getElementById('timeslot-display').textContent,
        timestamp: new Date().toLocaleTimeString()
    };
    
    recentAttendance.unshift(attendance);
    if (recentAttendance.length > 10) {
        recentAttendance.pop();
    }
    
    updateRecentAttendanceDisplay();
}

function updateRecentAttendanceDisplay() {
    const container = document.getElementById('recent-attendance');
    
    if (recentAttendance.length === 0) {
        container.innerHTML = '<p class="text-muted">No attendance marked yet.</p>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm">';
    html += '<thead><tr><th>Student</th><th>Course</th><th>Time</th><th>Marked At</th></tr></thead><tbody>';
    
    recentAttendance.forEach(att => {
        html += `<tr>
            <td>${att.student}</td>
            <td>${att.course}</td>
            <td>${att.timeSlot}</td>
            <td>${att.timestamp}</td>
        </tr>`;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function toggleManualEntry() {
    const manualEntry = document.getElementById('manual-entry');
    if (manualEntry.style.display === 'none') {
        manualEntry.style.display = 'block';
        document.getElementById('manual-qr-input').focus();
    } else {
        manualEntry.style.display = 'none';
    }
}

function manualMarkAttendance() {
    const qrHash = document.getElementById('manual-qr-input').value.trim();
    if (!qrHash) {
        showStatus('Please enter a QR code hash', 'error');
        return;
    }
    
    markAttendance(qrHash);
    document.getElementById('manual-qr-input').value = '';
    document.getElementById('manual-entry').style.display = 'none';
}

function testScanner() {
    console.log('Testing scanner functionality...');
    
    if (!currentCourseId || !currentTimeSlotId) {
        showStatus('Please select both course and time slot before testing', 'error');
        return;
    }
    
    // Test if we can create a scanner object
    if (typeof Html5QrcodeScanner === 'undefined') {
        showStatus('HTML5 QR Scanner library not loaded', 'error');
        return;
    }
    
    // Test if we can access the scanner container
    const scannerContainer = document.getElementById('qr-reader');
    if (!scannerContainer) {
        showStatus('Scanner container not found', 'error');
        return;
    }
    
    // Test camera availability
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                console.log('Camera access granted');
                showStatus('Camera access granted!', 'success');
                
                // Stop the stream
                stream.getTracks().forEach(track => track.stop());
                
                // Test if we can create a scanner instance
                try {
                    const testScanner = new Html5QrcodeScanner(
                        "qr-reader",
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        false
                    );
                    
                    showStatus('Scanner test successful! Library is working.', 'success');
                    
                    // Clean up test scanner
                    testScanner.clear();
                    
                    // Show test message in container
                    scannerContainer.innerHTML = '<div class="alert alert-success">Scanner test successful! Camera access granted. Click "Start Scanner" to begin scanning.</div>';
                    
                } catch (error) {
                    console.error('Scanner test failed:', error);
                    showStatus('Scanner test failed: ' + error.message, 'error');
                    scannerContainer.innerHTML = '<div class="alert alert-danger">Scanner test failed: ' + error.message + '</div>';
                }
            })
            .catch(function(err) {
                console.error('Camera access denied:', err);
                showStatus('Camera access denied: ' + err.message, 'error');
                scannerContainer.innerHTML = '<div class="alert alert-warning">Camera access denied. Please allow camera access to use the QR scanner.</div>';
            });
    } else {
        showStatus('Camera not available on this device', 'error');
        scannerContainer.innerHTML = '<div class="alert alert-danger">Camera not available on this device.</div>';
    }
}

function checkScannerStatus() {
    const status = {
        libraryLoaded: typeof Html5QrcodeScanner !== 'undefined',
        scannerActive: html5QrcodeScanner !== null,
        courseSelected: currentCourseId !== null,
        timeSlotSelected: currentTimeSlotId !== null,
        cameraAvailable: navigator.mediaDevices && navigator.mediaDevices.getUserMedia
    };
    
    console.log('Scanner Status:', status);
    
    let statusMessage = 'Scanner Status:\n';
    statusMessage += `Library Loaded: ${status.libraryLoaded ? '‚úÖ' : '‚ùå'}\n`;
    statusMessage += `Scanner Active: ${status.scannerActive ? '‚úÖ' : '‚ùå'}\n`;
    statusMessage += `Course Selected: ${status.courseSelected ? '‚úÖ' : '‚ùå'}\n`;
    statusMessage += `Time Slot Selected: ${status.timeSlotSelected ? '‚úÖ' : '‚ùå'}\n`;
    statusMessage += `Camera Available: ${status.cameraAvailable ? '‚úÖ' : '‚ùå'}`;
    
    showStatus(statusMessage, 'info');
    
    return status;
}

function testBasicJS() {
    console.log('Basic JS test function called');
    alert('Basic JavaScript is working!');
    
    // Test DOM manipulation
    const statusContainer = document.getElementById('status-container');
    if (statusContainer) {
        const testDiv = document.createElement('div');
        testDiv.className = 'status-message status-success';
        testDiv.textContent = 'Basic JavaScript test passed!';
        statusContainer.appendChild(testDiv);
        
        // Remove after 3 seconds
        setTimeout(() => {
            testDiv.remove();
        }, 3000);
    }
    
    // Test if we can access the scanner container
    const scannerContainer = document.getElementById('qr-reader');
    if (scannerContainer) {
        scannerContainer.innerHTML = '<div class="alert alert-info">Basic JS test passed! Scanner container is accessible.</div>';
    }
}

function checkLibraryManually() {
    console.log('Checking HTML5 QR library manually...');
    if (typeof Html5QrcodeScanner !== 'undefined') {
        showStatus('HTML5 QR Scanner library is already loaded!', 'info');
        
        // Test if we can create a scanner instance
        try {
            const testScanner = new Html5QrcodeScanner(
                "qr-reader",
                { fps: 10, qrbox: { width: 250, height: 250 } },
                false
            );
            showStatus('Library test successful! Can create scanner instance.', 'success');
            
            // Clean up test scanner
            testScanner.clear();
            
        } catch (error) {
            showStatus('Library loaded but scanner creation failed: ' + error.message, 'error');
        }
    } else {
        showStatus('HTML5 QR Scanner library is NOT loaded. Please refresh the page.', 'error');
    }
}

// Function to re-initialize after library loads
function initializeAfterLibraryLoad() {
    console.log('Library loaded, re-initializing scanner...');
    
    // Update the status
    if (typeof Html5QrcodeScanner !== 'undefined') {
        showStatus('HTML5 QR Scanner library loaded successfully!', 'success');
        
        // Re-run the DOM ready initialization
        if (typeof initializeSessionInfo === 'function') {
            initializeSessionInfo();
        }
        
        // Update the status display
        const statusButton = document.querySelector('.btn-outline-secondary');
        if (statusButton) {
            statusButton.innerHTML = '<i class="fas fa-info-circle"></i> Status (Library Ready)';
            statusButton.className = 'btn btn-success ms-2';
        }
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing attendance scanner...');
    
    // Check if HTML5 QR code library is loaded
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.error('‚ùå Html5QrcodeScanner is not defined. Library may not be loaded.');
        showStatus('QR Scanner library not loaded. Please refresh the page.', 'error');
        
        // Wait a bit and check again (in case local fallback is still loading)
        setTimeout(function() {
            if (typeof Html5QrcodeScanner !== 'undefined') {
                console.log('‚úÖ Html5QrcodeScanner is now available after delay');
                showStatus('QR Scanner library loaded successfully!', 'success');
            } else {
                console.error('‚ùå Html5QrcodeScanner still not available after delay');
            }
        }, 2000);
    } else {
        console.log('‚úÖ Html5QrcodeScanner is loaded successfully');
        showStatus('QR Scanner library loaded successfully!', 'success');
    }
    
    if (!initializeSessionInfo()) {
        console.error('Failed to initialize session info');
        return;
    }
    
    // Check if we came from a specific class (URL parameters)
    const urlParams = new URLSearchParams(window.location.search);
    const courseId = urlParams.get('course');
    const timeSlotId = urlParams.get('time_slot');
    
    console.log('URL Parameters found:', { courseId, timeSlotId });
    console.log('Full URL:', window.location.href);
    
    // Debug dropdown contents
    const courseSelect = document.getElementById('course-select');
    const timeSlotSelect = document.getElementById('timeslot-select');
    
    if (courseSelect) {
        console.log('Course dropdown found with options:', courseSelect.options.length);
        for (let i = 0; i < courseSelect.options.length; i++) {
            console.log(`Option ${i}:`, courseSelect.options[i].value, courseSelect.options[i].text);
        }
    } else {
        console.error('Course dropdown not found');
    }
    
    if (timeSlotSelect) {
        console.log('Time slot dropdown found with options:', timeSlotSelect.options.length);
        for (let i = 0; i < timeSlotSelect.options.length; i++) {
            console.log(`Option ${i}:`, timeSlotSelect.options[i].value, timeSlotSelect.options[i].text);
        }
    } else {
        console.error('Time slot dropdown not found');
    }
    
    if (courseId && timeSlotId) {
        console.log('Auto-filling dropdowns with:', { courseId, timeSlotId });
        
        if (courseSelect && timeSlotSelect) {
            // Check if the values exist in the dropdowns
            const courseExists = Array.from(courseSelect.options).some(opt => opt.value === courseId);
            const timeSlotExists = Array.from(timeSlotSelect.options).some(opt => opt.value === timeSlotId);
            
            console.log('Values exist in dropdowns:', { courseExists, timeSlotExists });
            
            if (courseExists && timeSlotExists) {
                courseSelect.value = courseId;
                timeSlotSelect.value = timeSlotId;
                updateSessionInfo();
                
                // Auto-start scanner after a short delay
                setTimeout(() => {
                    startScanner();
                }, 1000);
            } else {
                console.error('Course or time slot values not found in dropdowns');
            }
        } else {
            console.error('Dropdown elements not found');
        }
    } else {
        console.log('No URL parameters found. Manual selection required.');
    }

    // Add status check button after the existing buttons
    const buttonContainer = document.querySelector('.text-center.mt-3');
    if (buttonContainer) {
        const statusButton = document.createElement('button');
        statusButton.className = 'btn btn-outline-secondary ms-2';
        statusButton.onclick = checkScannerStatus;
        statusButton.innerHTML = '<i class="fas fa-info-circle"></i> Status';
        buttonContainer.appendChild(statusButton);
    }
});

// Also check on window load as a fallback
window.addEventListener('load', function() {
    console.log('üîÑ Window loaded, checking HTML5 QR library...');
    
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.error('‚ùå Html5QrcodeScanner still not defined after window load');
        
        // Try to load the library one more time
        console.log('üîÑ Attempting to load library again...');
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js';
        script.onload = function() {
            console.log('‚úÖ Library loaded successfully on second attempt');
            initializeAfterLibraryLoad();
        };
        script.onerror = function() {
            console.error('‚ùå Second attempt also failed, trying local version...');
            const localScript = document.createElement('script');
            localScript.src = '/static/js/html5-qrcode.min.js';
            localScript.onload = function() {
                console.log('‚úÖ Local version loaded successfully');
                initializeAfterLibraryLoad();
            };
            localScript.onerror = function() {
                console.error('‚ùå Local version also failed');
                showStatus('Failed to load QR scanner library. Please check your internet connection and refresh the page.', 'error');
            };
            document.head.appendChild(localScript);
        };
        document.head.appendChild(script);
    } else {
        console.log('‚úÖ Html5QrcodeScanner is now available after window load');
    }
});

// Add a periodic check for the library
setInterval(function() {
    if (typeof Html5QrcodeScanner === 'undefined') {
        console.log('üîÑ Periodic check: Library still not loaded');
    } else {
        console.log('‚úÖ Periodic check: Library is now loaded');
        clearInterval(this);
    }
}, 2000);
</script>
{% endblock %}
